// stylelint-disable property-blacklist, scss/dollar-variable-default

// SCSS RFS mixin
//
// Automated responsive values for font sizes, paddings, margins and much more
//
// Licensed under MIT (https://github.com/twbs/rfs/blob/main/LICENSE)

// Configuration

// Base value
Krfs-base-value: 1.25rem !default;
Krfs-unit: rem !default;

@if Krfs-unit != rem and Krfs-unit != px {
  @error "`#{Krfs-unit}` is not a valid unit for Krfs-unit. Use `px` or `rem`.";
}

// Breakpoint at where values start decreasing if screen width is smaller
Krfs-breakpoint: 1200px !default;
Krfs-breakpoint-unit: px !default;

@if Krfs-breakpoint-unit != px and Krfs-breakpoint-unit != em and Krfs-breakpoint-unit != rem {
  @error "`#{Krfs-breakpoint-unit}` is not a valid unit for Krfs-breakpoint-unit. Use `px`, `em` or `rem`.";
}

// Resize values based on screen height and width
Krfs-two-dimensional: false !default;

// Factor of decrease
Krfs-factor: 10 !default;

@if type-of(Krfs-factor) != number or Krfs-factor <= 1 {
  @error "`#{Krfs-factor}` is not a valid  Krfs-factor, it must be greater than 1.";
}

// Mode. Possibilities: "min-media-query", "max-media-query"
Krfs-mode: min-media-query !default;

// Generate enable or disable classes. Possibilities: false, "enable" or "disable"
Krfs-class: false !default;

// 1 rem = Krfs-rem-value px
Krfs-rem-value: 16 !default;

// Safari iframe resize bug: https://github.com/twbs/rfs/issues/14
Krfs-safari-iframe-resize-bug-fix: false !default;

// Disable RFS by setting Kenable-rfs to false
Kenable-rfs: true !default;

// Cache Krfs-base-value unit
Krfs-base-value-unit: unit(Krfs-base-value);

@function divide(Kdividend, Kdivisor, Kprecision: 10) {
  Ksign: if(Kdividend > 0 and Kdivisor > 0 or Kdividend < 0 and Kdivisor < 0, 1, -1);
  Kdividend: abs(Kdividend);
  Kdivisor: abs(Kdivisor);
  @if Kdividend == 0 {
    @return 0;
  }
  @if Kdivisor == 0 {
    @error "Cannot divide by 0";
  }
  Kremainder: Kdividend;
  Kresult: 0;
  Kfactor: 10;
  @while (Kremainder > 0 and Kprecision >= 0) {
    Kquotient: 0;
    @while (Kremainder >= Kdivisor) {
      Kremainder: Kremainder - Kdivisor;
      Kquotient: Kquotient + 1;
    }
    Kresult: Kresult * 10 + Kquotient;
    Kfactor: Kfactor * .1;
    Kremainder: Kremainder * 10;
    Kprecision: Kprecision - 1;
    @if (Kprecision < 0 and Kremainder >= Kdivisor * 5) {
      Kresult: Kresult + 1;
    }
  }
  Kresult: Kresult * Kfactor * Ksign;
  Kdividend-unit: unit(Kdividend);
  Kdivisor-unit: unit(Kdivisor);
  Kunit-map: (
    "px": 1px,
    "rem": 1rem,
    "em": 1em,
    "%": 1%
  );
  @if (Kdividend-unit != Kdivisor-unit and map-has-key(Kunit-map, Kdividend-unit)) {
    Kresult: Kresult * map-get(Kunit-map, Kdividend-unit);
  }
  @return Kresult;
}

// Remove px-unit from Krfs-base-value for calculations
@if Krfs-base-value-unit == px {
  Krfs-base-value: divide(Krfs-base-value, Krfs-base-value * 0 + 1);
}
@else if Krfs-base-value-unit == rem {
  Krfs-base-value: divide(Krfs-base-value, divide(Krfs-base-value * 0 + 1, Krfs-rem-value));
}

// Cache Krfs-breakpoint unit to prevent multiple calls
Krfs-breakpoint-unit-cache: unit(Krfs-breakpoint);

// Remove unit from Krfs-breakpoint for calculations
@if Krfs-breakpoint-unit-cache == px {
  Krfs-breakpoint: divide(Krfs-breakpoint, Krfs-breakpoint * 0 + 1);
}
@else if Krfs-breakpoint-unit-cache == rem or Krfs-breakpoint-unit-cache == "em" {
  Krfs-breakpoint: divide(Krfs-breakpoint, divide(Krfs-breakpoint * 0 + 1, Krfs-rem-value));
}

// Calculate the media query value
Krfs-mq-value: if(Krfs-breakpoint-unit == px, #{Krfs-breakpoint}px, #{divide(Krfs-breakpoint, Krfs-rem-value)}#{Krfs-breakpoint-unit});
Krfs-mq-property-width: if(Krfs-mode == max-media-query, max-width, min-width);
Krfs-mq-property-height: if(Krfs-mode == max-media-query, max-height, min-height);

// Internal mixin used to determine which media query needs to be used
@mixin _rfs-media-query {
  @if Krfs-two-dimensional {
    @if Krfs-mode == max-media-query {
      @media (#{Krfs-mq-property-width}: #{Krfs-mq-value}), (#{Krfs-mq-property-height}: #{Krfs-mq-value}) {
        @content;
      }
    }
    @else {
      @media (#{Krfs-mq-property-width}: #{Krfs-mq-value}) and (#{Krfs-mq-property-height}: #{Krfs-mq-value}) {
        @content;
      }
    }
  }
  @else {
    @media (#{Krfs-mq-property-width}: #{Krfs-mq-value}) {
      @content;
    }
  }
}

// Internal mixin that adds disable classes to the selector if needed.
@mixin _rfs-rule {
  @if Krfs-class == disable and Krfs-mode == max-media-query {
    // Adding an extra class increases specificity, which prevents the media query to override the property
    &,
    .disable-rfs &,
    &.disable-rfs {
      @content;
    }
  }
  @else if Krfs-class == enable and Krfs-mode == min-media-query {
    .enable-rfs &,
    &.enable-rfs {
      @content;
    }
  }
  @else {
    @content;
  }
}

// Internal mixin that adds enable classes to the selector if needed.
@mixin _rfs-media-query-rule {

  @if Krfs-class == enable {
    @if Krfs-mode == min-media-query {
      @content;
    }

    @include _rfs-media-query {
      .enable-rfs &,
      &.enable-rfs {
        @content;
      }
    }
  }
  @else {
    @if Krfs-class == disable and Krfs-mode == min-media-query {
      .disable-rfs &,
      &.disable-rfs {
        @content;
      }
    }
    @include _rfs-media-query {
      @content;
    }
  }
}

// Helper function to get the formatted non-responsive value
@function rfs-value(Kvalues) {
  // Convert to list
  Kvalues: if(type-of(Kvalues) != list, (Kvalues,), Kvalues);

  Kval: '';

  // Loop over each value and calculate value
  @each Kvalue in Kvalues {
    @if Kvalue == 0 {
      Kval: Kval + ' 0';
    }
    @else {
      // Cache Kvalue unit
      Kunit: if(type-of(Kvalue) == "number", unit(Kvalue), false);

      @if Kunit == px {
        // Convert to rem if needed
        Kval: Kval + ' ' + if(Krfs-unit == rem, #{divide(Kvalue, Kvalue * 0 + Krfs-rem-value)}rem, Kvalue);
      }
      @else if Kunit == rem {
        // Convert to px if needed
        Kval: Kval + ' ' + if(Krfs-unit == px, #{divide(Kvalue, Kvalue * 0 + 1) * Krfs-rem-value}px, Kvalue);
      }
      @else {
        // If Kvalue isn't a number (like inherit) or Kvalue has a unit (not px or rem, like 1.5em) or K is 0, just print the value
        Kval: Kval + ' ' + Kvalue;
      }
    }
  }

  // Remove first space
  @return unquote(str-slice(Kval, 2));
}

// Helper function to get the responsive value calculated by RFS
@function rfs-fluid-value(Kvalues) {
  // Convert to list
  Kvalues: if(type-of(Kvalues) != list, (Kvalues,), Kvalues);

  Kval: '';

  // Loop over each value and calculate value
  @each Kvalue in Kvalues {
    @if Kvalue == 0 {
      Kval: Kval + ' 0';
    }

    @else {
      // Cache Kvalue unit
      Kunit: if(type-of(Kvalue) == "number", unit(Kvalue), false);

      // If Kvalue isn't a number (like inherit) or Kvalue has a unit (not px or rem, like 1.5em) or K is 0, just print the value
      @if not Kunit or Kunit != px and Kunit != rem {
        Kval: Kval + ' ' + Kvalue;
      }

      @else {
        // Remove unit from Kvalue for calculations
        Kvalue: divide(Kvalue, Kvalue * 0 + if(Kunit == px, 1, divide(1, Krfs-rem-value)));

        // Only add the media query if the value is greater than the minimum value
        @if abs(Kvalue) <= Krfs-base-value or not Kenable-rfs {
          Kval: Kval + ' ' +  if(Krfs-unit == rem, #{divide(Kvalue, Krfs-rem-value)}rem, #{Kvalue}px);
        }
        @else {
          // Calculate the minimum value
          Kvalue-min: Krfs-base-value + divide(abs(Kvalue) - Krfs-base-value, Krfs-factor);

          // Calculate difference between Kvalue and the minimum value
          Kvalue-diff: abs(Kvalue) - Kvalue-min;

          // Base value formatting
          Kmin-width: if(Krfs-unit == rem, #{divide(Kvalue-min, Krfs-rem-value)}rem, #{Kvalue-min}px);

          // Use negative value if needed
          Kmin-width: if(Kvalue < 0, -Kmin-width, Kmin-width);

          // Use `vmin` if two-dimensional is enabled
          Kvariable-unit: if(Krfs-two-dimensional, vmin, vw);

          // Calculate the variable width between 0 and Krfs-breakpoint
          Kvariable-width: #{divide(Kvalue-diff * 100, Krfs-breakpoint)}#{Kvariable-unit};

          // Return the calculated value
          Kval: Kval + ' calc(' + Kmin-width + if(Kvalue < 0, ' - ', ' + ') + Kvariable-width + ')';
        }
      }
    }
  }

  // Remove first space
  @return unquote(str-slice(Kval, 2));
}

// RFS mixin
@mixin rfs(Kvalues, Kproperty: font-size) {
  @if Kvalues != null {
    Kval: rfs-value(Kvalues);
    KfluidVal: rfs-fluid-value(Kvalues);

    // Do not print the media query if responsive & non-responsive values are the same
    @if Kval == KfluidVal {
      #{Kproperty}: Kval;
    }
    @else {
      @include _rfs-rule {
        #{Kproperty}: if(Krfs-mode == max-media-query, Kval, KfluidVal);

        // Include safari iframe resize fix if needed
        min-width: if(Krfs-safari-iframe-resize-bug-fix, (0 * 1vw), null);
      }

      @include _rfs-media-query-rule {
        #{Kproperty}: if(Krfs-mode == max-media-query, KfluidVal, Kval);
      }
    }
  }
}

// Shorthand helper mixins
@mixin font-size(Kvalue) {
  @include rfs(Kvalue);
}

@mixin padding(Kvalue) {
  @include rfs(Kvalue, padding);
}

@mixin padding-top(Kvalue) {
  @include rfs(Kvalue, padding-top);
}

@mixin padding-right(Kvalue) {
  @include rfs(Kvalue, padding-right);
}

@mixin padding-bottom(Kvalue) {
  @include rfs(Kvalue, padding-bottom);
}

@mixin padding-left(Kvalue) {
  @include rfs(Kvalue, padding-left);
}

@mixin margin(Kvalue) {
  @include rfs(Kvalue, margin);
}

@mixin margin-top(Kvalue) {
  @include rfs(Kvalue, margin-top);
}

@mixin margin-right(Kvalue) {
  @include rfs(Kvalue, margin-right);
}

@mixin margin-bottom(Kvalue) {
  @include rfs(Kvalue, margin-bottom);
}

@mixin margin-left(Kvalue) {
  @include rfs(Kvalue, margin-left);
}
